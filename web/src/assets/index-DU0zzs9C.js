import{j as t,L as P,o as v,B as Me,S as Ae,R as $e,t as K,C as I,x as b,J as q}from"./semi-ui-C9AnQoBc.js";import{r as c}from"./react-core-B_rT1BcQ.js";import{l as ne,V as A,a as re}from"./visactor-K-BgCAvg.js";import{U as Ie,a as Le,t as L,i as Re,r as Q,m as H,c as y,A as se,b as le,d as Ne,e as ie,g as Pe}from"./index-BAKq1-I6.js";import{u as Ke}from"./i18n-CErUK-Hy.js";import"./semantic-Du-5yReK.js";import"./tools--jVf5iHv.js";import"./react-components-DHMQhW6Z.js";const ue="Inter,-apple-system,BlinkMacSystemFont,Segoe UI,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Helvetica Neue,Helvetica,Arial,sans-serif",V="theme-mode",ce=(l,e,u)=>{const r=l&&getComputedStyle(document.body).getPropertyValue(l)||e;return r&&!isNaN(r[0])?`rgba(${r})`:r},qe=(l,e,u)=>{new MutationObserver(r=>{r.forEach(s=>{s.attributeName===e&&u(s)})}).observe(l,{attributes:!0})},Qe=(l,e,u,r)=>e.map((s,h)=>{const{scheme:p}=u[h];return Object.assign(Object.assign({},s),{scheme:s.scheme.map((F,_)=>ce(typeof F=="object"?F[l]:F,p==null?void 0:p[_]))})}),He=(l,e,u,r)=>{const s={};return Object.keys(e).forEach(h=>{const p=typeof e[h]=="object"?e[h][l]:e[h];s[h]=ce(p,u[h])}),s},me=()=>document.body.hasAttribute(V)&&document.body.getAttribute(V)==="dark"?"dark":"light",Oe=l=>`semiDesign${l[0].toUpperCase()}${l.slice(1)}`,Ve=l=>{new MutationObserver(e=>{e.forEach(u=>{var r;if(u.addedNodes.length===1){const s=u.addedNodes[0];s.tagName==="LINK"&&((r=s.getAttribute)===null||r===void 0?void 0:r.call(s,"semi-theme-switcher"))==="true"&&l(u,s)}})}).observe(document.body,{childList:!0})},Ue={default:{dataScheme:ne.colorScheme.default.dataScheme,palette:{backgroundColor:"#16161a",borderColor:"rgba(255,255,255,0.08)",shadowColor:"rgba(0,0,0,0.25)",hoverBackgroundColor:"rgba(255,255,255,0.12)",sliderRailColor:"rgba(255,255,255,0.12)",sliderHandleColor:"#e4e7f5",sliderTrackColor:"rgba(84,169,255,1)",popupBackgroundColor:"#43444a",primaryFontColor:"rgba(249,249,249,1)",secondaryFontColor:"rgba(249,249,249,0.8)",tertiaryFontColor:"rgba(249,249,249,0.6)",axisLabelFontColor:"rgba(249,249,249,0.6)",disableFontColor:"rgba(249,249,249,0.35)",axisMarkerFontColor:"#16161a",axisGridColor:"rgba(255,255,255,0.08)",axisDomainColor:"rgba(255,255,255,0.08)",dataZoomHandleStrokeColor:"rgba(46,50,56,0.13)",dataZoomChartColor:"rgba(255,255,255,0.16)",playerControllerColor:"rgba(84,169,255,1)",axisMarkerBackgroundColor:"rgba(249,249,249,1)",markLabelBackgroundColor:"rgba(255,255,255,0.08)",markLineStrokeColor:"rgba(249,249,249,0.8)",dangerColor:"rgba(252,114,90,1)",warningColor:"rgba(255,174,67,1)",successColor:"rgba(93,194,100,1)",infoColor:"rgba(84,169,255,1)"}}},We={name:"semiDesignDark",description:"Semi Design - dark",type:"dark",fontFamily:ue,colorScheme:Ue},Ze={default:{dataScheme:ne.colorScheme.default.dataScheme,palette:{backgroundColor:"rgba(255,255,255,1)",borderColor:"rgba(28,31,35,0.08)",shadowColor:"rgba(0,0,0,0.1)",hoverBackgroundColor:"rgba(46,50,56,0.05)",sliderRailColor:"rgba(46,50,56,0.05)",sliderHandleColor:"rgba(255,255,255,1)",sliderTrackColor:"rgba(0,100,250,1)",popupBackgroundColor:"rgba(255,255,255,1)",primaryFontColor:"rgba(28,31,35,1)",secondaryFontColor:"rgba(28,31,35,0.8)",tertiaryFontColor:"rgba(28,31,35,0.62)",axisLabelFontColor:"rgba(28,31,35,0.62)",disableFontColor:"rgba(28,31,35,0.35)",axisMarkerFontColor:"rgba(255,255,255,1)",axisGridColor:"rgba(28,31,35,0.08)",axisDomainColor:"rgba(28,31,35,0.15)",dataZoomHandleStrokeColor:"rgba(46,50,56,0.13)",dataZoomChartColor:"rgba(46,50,56,0.09)",playerControllerColor:"rgba(0,100,250,1)",axisMarkerBackgroundColor:"rgba(28,31,35,1)",markLabelBackgroundColor:"rgba(28,31,35,0.08)",markLineStrokeColor:"rgba(28,31,35,0.8)",dangerColor:"rgba(249,57,32,1)",warningColor:"rgba(252,136,0,1)",successColor:"rgba(59,179,70,1)",infoColor:"rgba(0,100,250,1)"}}},ze={name:"semiDesignLight",description:"Semi Design - light",type:"light",fontFamily:ue,colorScheme:Ze},Ge={backgroundColor:"--semi-color-bg-0",borderColor:"--semi-color-border",hoverBackgroundColor:"--semi-color-fill-0",sliderRailColor:"--semi-color-fill-0",sliderHandleColor:"--semi-white",sliderTrackColor:"--semi-color-primary",popupBackgroundColor:"--semi-color-bg-3",primaryFontColor:"--semi-color-text-0",secondaryFontColor:"--semi-color-text-1",tertiaryFontColor:"--semi-color-text-2",axisLabelFontColor:"--semi-color-text-0",disableFontColor:"--semi-color-disabled-text",axisMarkerFontColor:"--semi-color-bg-0",axisGridColor:"--semi-color-border",axisDomainColor:{light:"--semi-grey-9",dark:"--semi-color-border"},dataZoomHandleStrokeColor:{light:"--semi-color-fill-2"},dataZoomChartColor:"--semi-color-fill-1",playerControllerColor:"--semi-color-primary",axisMarkerBackgroundColor:"--semi-color-text-0",markLabelBackgroundColor:"--semi-color-border",markLineStrokeColor:"--semi-color-text-1",dangerColor:"--semi-color-danger",warningColor:"--semi-color-warning",successColor:"--semi-color-success",infoColor:"--semi-color-info"},Je=[{maxDomainLength:10,scheme:["--semi-color-data-0","--semi-color-data-2","--semi-color-data-4","--semi-color-data-6","--semi-color-data-8","--semi-color-data-10","--semi-color-data-12","--semi-color-data-14","--semi-color-data-16","--semi-color-data-18"]},{scheme:["--semi-color-data-0","--semi-color-data-1","--semi-color-data-2","--semi-color-data-3","--semi-color-data-4","--semi-color-data-5","--semi-color-data-6","--semi-color-data-7","--semi-color-data-8","--semi-color-data-9","--semi-color-data-10","--semi-color-data-11","--semi-color-data-12","--semi-color-data-13","--semi-color-data-14","--semi-color-data-15","--semi-color-data-16","--semi-color-data-17","--semi-color-data-18","--semi-color-data-19"]}],Ye={light:ze,dark:We},U=(l,e)=>{const u=Ye[l],{dataScheme:r,palette:s}=u.colorScheme.default,h={default:{dataScheme:Qe(l,Je,r),palette:He(l,Ge,s)}};return Object.assign(Object.assign({},u),{colorScheme:h})},Xe=l=>{const{defaultMode:e,isWatchingMode:u=!0,isWatchingThemeSwitch:r=!1}=l??{};O(!1,e),u&&qe(document.body,V,()=>O()),r&&Ve(()=>{const s=me(),h=JSON.stringify(U(s).colorScheme);let p=0;const F=setInterval(()=>{const _=U(s);(p>50||h!==JSON.stringify(_.colorScheme))&&(O(!0,s,_),clearInterval(F)),p++},100)})},O=(l,e,u)=>{e||(e=me());const r=Oe(e);(l||A.ThemeManager.getCurrentTheme()!==r)&&(l&&A.ThemeManager.removeTheme(r),A.ThemeManager.themeExist(r)||A.ThemeManager.registerTheme(r,u??U(e)),A.ThemeManager.setCurrentTheme(r))},mt=l=>{var te,ae,oe;const{t:e}=Ke(),u=c.useRef();let r=new Date;const[s,h]=c.useContext(Ie),[p,F]=c.useContext(Le),[_,de]=c.useState({username:"",token_name:"",model_name:"",start_timestamp:localStorage.getItem("data_export_default_time")==="hour"?L(r.getTime()/1e3-86400):localStorage.getItem("data_export_default_time")==="week"?L(r.getTime()/1e3-86400*30):L(r.getTime()/1e3-86400*7),end_timestamp:L(r.getTime()/1e3+3600),channel:"",data_export_default_time:""}),{username:W,model_name:et,start_timestamp:j,end_timestamp:w,channel:tt}=_,Z=Re(),z=c.useRef(!1),[G,J]=c.useState(!1),[at,he]=c.useState([]),[Y,ge]=c.useState(0),[X,pe]=c.useState(0),[R,be]=c.useState(0),[S,Ce]=c.useState(localStorage.getItem("data_export_default_time")||"hour"),[fe,xe]=c.useState([{type:"null",value:"0"}]),[ye,Se]=c.useState([]),[Te,ke]=c.useState({type:"pie",data:[{id:"id0",values:fe}],outerRadius:.8,innerRadius:.5,padAngle:.6,valueField:"value",categoryField:"type",pie:{style:{cornerRadius:10},state:{hover:{outerRadius:.85,stroke:"#000",lineWidth:1},selected:{outerRadius:.85,stroke:"#000",lineWidth:1}}},title:{visible:!0,text:e("模型调用次数占比"),subtext:`${e("总计")}：${Q(R)}`},legends:{visible:!0,orient:"left"},label:{visible:!0},tooltip:{mark:{content:[{key:a=>a.type,value:a=>Q(a.value)}]}},color:{specified:H}}),[Fe,_e]=c.useState({type:"bar",data:[{id:"barData",values:ye}],xField:"Time",yField:"Usage",seriesField:"Model",stack:!0,legends:{visible:!0,selectMode:"single"},title:{visible:!0,text:e("模型消耗分布"),subtext:`${e("总计")}：${y(Y,2)}`},bar:{state:{hover:{stroke:"#000",lineWidth:1}}},tooltip:{mark:{content:[{key:a=>a.Model,value:a=>y(a.rawQuota||0,4)}]},dimension:{content:[{key:a=>a.Model,value:a=>a.rawQuota||0}],updateContent:a=>{a.sort((i,g)=>g.value-i.value);let m=0;for(let i=0;i<a.length;i++){if(a[i].key=="其他")continue;let g=parseFloat(a[i].value);isNaN(g)&&(g=0),a[i].datum&&a[i].datum.TimeSum&&(m=a[i].datum.TimeSum),a[i].value=y(g,4)}return a.unshift({key:e("总计"),value:y(m,4)}),a}}},color:{specified:H}}),[De,ve]=c.useState({}),$=(a,m)=>{if(m==="data_export_default_time"){Ce(a);return}de(i=>({...i,[m]:a}))},ee=async()=>{J(!0);try{let a="",m=Date.parse(j)/1e3,i=Date.parse(w)/1e3;Z?a=`/api/data/?username=${W}&start_timestamp=${m}&end_timestamp=${i}&default_time=${S}`:a=`/api/data/self/?start_timestamp=${m}&end_timestamp=${i}&default_time=${S}`;const g=await se.get(a),{success:B,message:E,data:C}=g.data;B?(he(C),C.length===0&&C.push({count:0,model_name:"无数据",quota:0,created_at:r.getTime()/1e3}),C.sort((D,f)=>D.created_at-f.created_at),Be(C)):le(E)}finally{J(!1)}},je=async()=>{await ee()},we=async()=>{await ee()},Be=a=>{let m=[],i=[],g=0,B=0,E=new Set,C=0;a.forEach(o=>{E.add(o.model_name),C+=o.token_used,g+=o.quota,B+=o.count});const D={};Array.from(E).forEach(o=>{D[o]=H[o]||De[o]||Ne(o)}),ve(D);let f=new Map;a.forEach(o=>{const n=ie(o.created_at,S),T=o.model_name,d=`${n}-${T}`;f.has(d)||f.set(d,{time:n,model:T,quota:0,count:0});const x=f.get(d);x.quota+=o.quota,x.count+=o.count});let M=new Map;for(let[o,n]of f)M.has(n.model)||M.set(n.model,0),M.set(n.model,M.get(n.model)+n.count);m=Array.from(M).map(([o,n])=>({type:o,value:n}));let N=Array.from(new Set([...f.values()].map(o=>o.time)));if(N.length<7){const o=Math.max(...a.map(T=>T.created_at)),n=S==="hour"?3600:S==="day"?86400:604800;N=Array.from({length:7},(T,d)=>ie(o-(6-d)*n,S))}N.forEach(o=>{let n=Array.from(E).map(d=>{const x=`${o}-${d}`,k=f.get(x);return{Time:o,Model:d,rawQuota:(k==null?void 0:k.quota)||0,Usage:k!=null&&k.quota?Pe(k.quota,4):0}});const T=n.reduce((d,x)=>d+x.rawQuota,0);n.sort((d,x)=>x.rawQuota-d.rawQuota),n=n.map(d=>({...d,TimeSum:T})),i.push(...n)}),m.sort((o,n)=>n.value-o.value),i.sort((o,n)=>o.Time.localeCompare(n.Time)),ke(o=>({...o,data:[{id:"id0",values:m}],title:{...o.title,subtext:`${e("总计")}：${Q(B)}`},color:{specified:D}})),_e(o=>({...o,data:[{id:"barData",values:i}],title:{...o.title,subtext:`${e("总计")}：${y(g,2)}`},color:{specified:D}})),xe(m),Se(i),ge(g),be(B),pe(C)},Ee=async()=>{let a=await se.get("/api/user/self");const{success:m,message:i,data:g}=a.data;m?h({type:"login",payload:g}):le(i)};return c.useEffect(()=>{Ee(),z.current||(Xe({isWatchingThemeSwitch:!0}),z.current=!0,we())},[]),t.jsx(t.Fragment,{children:t.jsxs(P,{children:[t.jsx(P.Header,{children:t.jsx("h3",{children:e("数据看板")})}),t.jsxs(P.Content,{children:[t.jsx(v,{ref:u,layout:"horizontal",style:{marginTop:10},children:t.jsxs(t.Fragment,{children:[t.jsx(v.DatePicker,{field:"start_timestamp",label:e("起始时间"),style:{width:272},initValue:j,value:j,type:"dateTime",name:"start_timestamp",onChange:a=>$(a,"start_timestamp")}),t.jsx(v.DatePicker,{field:"end_timestamp",fluid:!0,label:e("结束时间"),style:{width:272},initValue:w,value:w,type:"dateTime",name:"end_timestamp",onChange:a=>$(a,"end_timestamp")}),t.jsx(v.Select,{field:"data_export_default_time",label:e("时间粒度"),style:{width:176},initValue:S,placeholder:e("时间粒度"),name:"data_export_default_time",optionList:[{label:e("小时"),value:"hour"},{label:e("天"),value:"day"},{label:e("周"),value:"week"}],onChange:a=>$(a,"data_export_default_time")}),Z&&t.jsx(t.Fragment,{children:t.jsx(v.Input,{field:"username",label:e("用户名称"),style:{width:176},value:W,placeholder:e("可选值"),name:"username",onChange:a=>$(a,"username")})}),t.jsx(Me,{label:e("查询"),type:"primary",htmlType:"submit",className:"btn-margin-right",onClick:je,loading:G,style:{marginTop:24},children:e("查询")}),t.jsx(v.Section,{})]})}),t.jsxs(Ae,{spinning:G,children:[t.jsxs($e,{gutter:{xs:16,sm:16,md:16,lg:24,xl:24,xxl:24},style:{marginTop:20},type:"flex",justify:"space-between",children:[t.jsx(K,{span:p.isMobile?24:8,children:t.jsx(I,{className:"panel-desc-card",children:t.jsxs(b,{row:!0,size:"small",children:[t.jsx(b.Item,{itemKey:e("当前余额"),children:y((te=s==null?void 0:s.user)==null?void 0:te.quota)}),t.jsx(b.Item,{itemKey:e("历史消耗"),children:y((ae=s==null?void 0:s.user)==null?void 0:ae.used_quota)}),t.jsx(b.Item,{itemKey:e("请求次数"),children:(oe=s.user)==null?void 0:oe.request_count})]})})}),t.jsx(K,{span:p.isMobile?24:8,children:t.jsx(I,{children:t.jsxs(b,{row:!0,size:"small",children:[t.jsx(b.Item,{itemKey:e("统计额度"),children:y(Y)}),t.jsx(b.Item,{itemKey:e("统计Tokens"),children:X}),t.jsx(b.Item,{itemKey:e("统计次数"),children:R})]})})}),t.jsx(K,{span:p.isMobile?24:8,children:t.jsx(I,{children:t.jsxs(b,{row:!0,size:"small",children:[t.jsx(b.Item,{itemKey:e("平均RPM"),children:(R/((Date.parse(w)-Date.parse(j))/6e4)).toFixed(3)}),t.jsx(b.Item,{itemKey:e("平均TPM"),children:(X/((Date.parse(w)-Date.parse(j))/6e4)).toFixed(3)})]})})})]}),t.jsx(I,{style:{marginTop:20},children:t.jsxs(q,{type:"line",defaultActiveKey:"1",children:[t.jsx(q.TabPane,{tab:e("消耗分布"),itemKey:"1",children:t.jsx("div",{style:{height:500},children:t.jsx(re,{spec:Fe,option:{mode:"desktop-browser"}})})}),t.jsx(q.TabPane,{tab:e("调用次数分布"),itemKey:"2",children:t.jsx("div",{style:{height:500},children:t.jsx(re,{spec:Te,option:{mode:"desktop-browser"}})})})]})})]})]})]})})};export{mt as default};
